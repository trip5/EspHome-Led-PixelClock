name: Build ESPHome Firmware

on:
  workflow_dispatch:
  push:
    tags:
      - '*'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for tags
    
    - name: Install yq
      run: |
        sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
        sudo chmod +x /usr/local/bin/yq
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install ESPHome
      run: |
        pip install esphome
    
    - name: Download font files
      run: |
        echo "ðŸ“¥ Downloading font files from Matrix-Fonts repository..."
        mkdir -p generated_yamls/fonts
        
        # Download BDF fonts directly to where the YAML files expect them
        curl -L -o generated_yamls/fonts/MatrixChunky8X.bdf "https://github.com/trip5/Matrix-Fonts/raw/refs/heads/main/8-series/MatrixChunky8X.bdf"
        curl -L -o generated_yamls/fonts/MatrixLight8X.bdf "https://github.com/trip5/Matrix-Fonts/raw/refs/heads/main/8-series/MatrixLight8X.bdf"
        
        echo "âœ… Downloaded font files to generated_yamls/fonts/:"
        ls -la generated_yamls/fonts/
    
    - name: Get version tag
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          # Manual trigger - extract version from EHLPClock.yaml
          VERSION=$(yq eval '.substitutions.project_version' EHLPClock.yaml | tr -d '"')
          TAG="${VERSION}"
          echo "Extracted version from YAML: ${VERSION}"
        else
          # Tag push - get the tag
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#v}
          echo "Using git tag: ${TAG}"
        fi
        
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "tag=${TAG}" >> $GITHUB_OUTPUT
        echo "Final version: ${VERSION}"
    
    - name: Generate language variants
      run: |
        echo "ðŸ”„ Generating language-specific YAML files..."
        
        # Create output directory
        mkdir -p generated_yamls
        
        # Prepare base file with improv_serial and remove secrets (for merging with languages)
        echo "ðŸ”§ Preparing base YAML for language merging..."
        cp EHLPClock.yaml generated_yamls/EHLPClock-base.yaml
        cp EHLPClock-HA.yaml generated_yamls/EHLPClock-HA-base.yaml
        
        # Remove captive_portal and add improv_serial before wifi section
        sed -i '/^captive_portal:/d' generated_yamls/EHLPClock-base.yaml
        sed -i '/^wifi:/i\improv_serial:\n' generated_yamls/EHLPClock-base.yaml
        sed -i '/^captive_portal:/d' generated_yamls/EHLPClock-HA-base.yaml
        sed -i '/^wifi:/i\improv_serial:\n' generated_yamls/EHLPClock-HA-base.yaml
        
        # Remove secret dependencies
        for base_file in generated_yamls/EHLPClock-base.yaml generated_yamls/EHLPClock-HA-base.yaml; do
          sed -i 's/- ssid: !secret wifi_ssid/# - ssid: !secret wifi_ssid/' "$base_file"
          sed -i 's/password: !secret wifi_password/# password: !secret wifi_password/' "$base_file"
          sed -i '/password: !secret ap_password/d' "$base_file"
          sed -i '/password: !secret ota_password/d' "$base_file"
          sed -i '/key: !secret encryption_key/d' "$base_file"
        done
        
        # Generate language variants (English + Second Language)
        for base_name in EHLPClock EHLPClock-HA; do
          for lang_file in language_filters/*.yaml; do
            if [ -f "$lang_file" ]; then
              lang_name=$(basename "$lang_file" .yaml)
              output_file="generated_yamls/${base_name}-${lang_name}.yaml"
              
              echo "ðŸ“ Creating bilingual ${output_file} (English + ${lang_name})..."
              
              # Use yq to merge files with ID-aware replacement strategy
              # Fonts: Complete replacement when IDs match
              # Text sensors: Only replace specific ones (time_text, date_text, dateA_text)
              yq eval-all '
                select(fileIndex == 0) as $base |
                select(fileIndex == 1) as $lang |
                
                # Get font IDs that exist in language file for replacement
                ($lang.font // [] | map(.id)) as $lang_font_ids |
                
                # Start with base, then apply smart merge
                $base * $lang |
                
                # Font merge: Keep base fonts that are not being replaced + all language fonts
                .font = (
                  ($base.font // [] | map(select(.id as $id | $lang_font_ids | contains([$id]) | not))) +
                  ($lang.font // [])
                ) |
                
                # Text sensor merge: Only replace the 3 specific language text sensors
                .text_sensor = (
                  ($base.text_sensor // [] | map(select(.id != "time_text" and .id != "date_text" and .id != "dateA_text"))) +
                  ($lang.text_sensor // [])
                )
              ' "generated_yamls/${base_name}-base.yaml" "$lang_file" > "$output_file"
              
              echo "âœ… Generated ${output_file}"
            fi
          done
        done
        
        # Clean up timezone offset code from HA versions
        echo "ðŸ§¹ Cleaning timezone offset code from HA versions..."
        for ha_file in generated_yamls/EHLPClock-HA-*.yaml; do
          if [ -f "$ha_file" ]; then
            echo "Cleaning timezone references from $ha_file"
            
            # Remove the timezone offset if block and its contents
            # This removes the entire if statement that contains tzoffset references
            sed -i '/if (id(tzoffset_on)/,/^[[:space:]]*}/d' "$ha_file"
            
            # Also remove any standalone tzoffset references that might remain
            sed -i '/tzoffset_on\|tzoffset\.state/d' "$ha_file"
            
            # Remove the comment line that mentions deleting for HA version
            sed -i '/delete.*HA version/d' "$ha_file"
            
            echo "âœ… Cleaned $ha_file"
          fi
        done
        
        echo "ï¿½ Generated firmware files:"
        ls -la firmware/ || echo "No firmware directory created"
    
    - name: Validate YAML files
      run: |
        echo "ðŸ” Validating generated YAML files..."
        
        # First, let's check what font files we actually downloaded
        echo "ðŸ“‚ Checking downloaded font files:"
        ls -la generated_yamls/fonts/
        file generated_yamls/fonts/* || echo "No font files found"
        
        for yaml_file in generated_yamls/*.yaml; do
          echo "Validating $yaml_file..."
          esphome config "$yaml_file"
        done
        echo "âœ… All YAML files are valid"
    
    - name: Compile ESPHome firmwares
      run: |
        echo "ðŸ”¨ Compiling ESPHome firmwares..."
        
        # Create firmware output directory
        mkdir -p firmware
        
        for yaml_file in generated_yamls/*.yaml; do
          filename=$(basename "$yaml_file" .yaml)
          echo "ðŸ”¨ Building ${filename}..."
          
          # Compile the firmware
          esphome compile "$yaml_file"
          
          # Find the generated binary and copy it
          # The device name uses substitutions, so we need to get the actual resolved name
          # ESPHome creates the build directory with the resolved name, so find it
          device_name=$(find generated_yamls/.esphome/build/ -maxdepth 1 -type d ! -name "build" -printf "%f\n" 2>/dev/null | head -1)
          
          if [ -z "$device_name" ]; then
            # Fallback: try to get from substitutions
            device_name=$(yq eval '.substitutions.name' "$yaml_file" | tr -d '"')
          fi
          
          possible_paths=(
            "generated_yamls/.esphome/build/${device_name}/.pioenvs/${device_name}/firmware.bin"
            ".pioenvs/${device_name}/firmware.bin"
            "${device_name}/.pioenvs/${device_name}/firmware.bin"
            ".esphome/build/${device_name}/.pioenvs/${device_name}/firmware.bin"
          )
          
          binary_found=false
          for binary_path in "${possible_paths[@]}"; do
            if [ -f "$binary_path" ]; then
              cp "$binary_path" "firmware/${filename}.bin"
              echo "âœ… Copied ${filename}.bin from $binary_path"
              binary_found=true
              break
            fi
          done
          
          if [ "$binary_found" = false ]; then
            echo "âŒ Binary not found for ${filename}"
            echo "Searched in:"
            for path in "${possible_paths[@]}"; do
              echo "  - $path"
            done
            # List what's actually there for debugging
            find . -name "firmware.bin" -type f 2>/dev/null || echo "No firmware.bin files found anywhere"
          fi
          break  # TESTING: Remove this line to build all variants
        done
        
        echo "ðŸ“¦ Generated firmware files:"
        ls -la firmware/ || echo "No firmware directory created"
    
    - name: Create firmware manifests
      run: |
        echo "ðŸ“ Creating firmware manifests..."
        
        # Create individual manifest files for each firmware variant
        mkdir -p docs/manifests
        
        for bin_file in firmware/EHLPClock-*.bin; do
          if [ -f "$bin_file" ]; then
            filename=$(basename "$bin_file")
            lang_name=$(echo "$filename" | sed 's/EHLPClock-\([^.]*\)\.bin/\1/')
            manifest_file="docs/manifests/${lang_name}-manifest.json"
            
            # Create manifest with absolute URL to release asset
            cat > "$manifest_file" <<MANIFEST_EOF
{
  "name": "EspHome-Led-PixelClock",
  "version": "${{ steps.get_version.outputs.version }}",
  "home_assistant_domain": "esphome",
  "funding_url": "https://github.com/sponsors/trip5",
  "builds": [
    {
      "chipFamily": "ESP8266",
      "parts": [
        {
          "path": "https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.tag }}/${filename}",
          "offset": 0
        }
      ]
    }
  ]
}
MANIFEST_EOF
            echo "Created manifest: $manifest_file"
          fi
        done
        
        # Create firmware info JSON for the web interface
        BUILD_DATE=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
        cat > docs/firmware-info.json <<INFO_EOF
{
  "project": "EspHome-Led-PixelClock",
  "version": "${{ steps.get_version.outputs.version }}",
  "build_date": "${BUILD_DATE}",
  "variants": [
INFO_EOF
        
        # Add variants info
        FIRST=true
        for bin_file in firmware/EHLPClock-*.bin; do
          if [ -f "$bin_file" ]; then
            filename=$(basename "$bin_file")
            lang_name=$(echo "$filename" | sed 's/EHLPClock-\([^.]*\)\.bin/\1/')
            
            if [ "$FIRST" = "false" ]; then
              echo "  ," >> docs/firmware-info.json
            fi
            FIRST=false
            
            cat >> docs/firmware-info.json <<VARIANT_EOF
  {
    "name": "${lang_name}",
    "manifest": "manifests/${lang_name}-manifest.json",
    "description": "English + ${lang_name} bilingual firmware"
  }
VARIANT_EOF
          fi
        done
        
        cat >> docs/firmware-info.json <<'CLOSE_EOF'
  ]
}
CLOSE_EOF
        
        echo "âœ… Created firmware manifests and info"
    
    - name: Commit manifest files to docs
      run: |
        # Commit manifest files to docs folder for CORS-free access via GitHub Pages
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add docs/manifests/*.json docs/firmware-info.json
        git commit -m "Update firmware manifests for ${{ steps.get_version.outputs.version }}" || echo "No changes to commit"
        git push || echo "Nothing to push"
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.tag }}
        name: "EspHome-Led-PixelClock ${{ steps.get_version.outputs.version }}"
        body: |
          Compiled firmware binaries for EspHome-Led-PixelClock with different second-language options (all have English as a first language).
          
          You can download the firmware and flash yourself or you can use my [Web Installer](https://trip5.github.io/EspHome-Led-PixelClock/firmware.html).

          These firmwares can get Wi-fi SSID and password through Improv via Serial or through the captive portal.

          You can use the tool provided above or the official one at [Improv-wifi](https://www.improv-wifi.com/) (click on 'Improv via Serial').

          The captive portal will make a hotspot with the name of the clock.  Connect to it and visit http://192.168.4.1 to configure the wi-fi.
        files: |
          firmware/*.bin
        fail_on_unmatched_files: false
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}